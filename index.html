<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#0a0f1f" />
  <title>Math Mastery Quiz</title>
  <style>
    :root{
      --bg: #0a0f1f;
      --panel: rgba(255,255,255,0.07);
      --panel-2: rgba(255,255,255,0.05);
      --stroke: rgba(255,255,255,0.12);
      --text: #e6ecff;
      --muted: #9db0e7;
      --accent-1: #6b9cff;
      --accent-2: #9c6bff;
      --accent-3: #00e0ff;
      --good: #38e08d;
      --bad: #ff6b6b;
      --warn: #ffb86b;
      --shadow-1: 0 10px 30px rgba(0,0,0,0.35);
      --shadow-2: 0 10px 50px rgba(24, 78, 180, 0.35);
      --radius-xl: 18px;
      --radius-lg: 14px;
      --radius-md: 10px;
      --radius-sm: 8px;
      --blur: 10px;
      --speed: 300ms;
    }
    *{box-sizing:border-box}
    html, body{
      margin:0; padding:0; height:100%;
      background: var(--bg);
      color: var(--text);
      font: 16px/1.45 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    a{color:inherit; text-decoration:none;}
    button{font:inherit; color:inherit; border:none; background:none; cursor:pointer}
    .app{
      position:relative; min-height:100vh; overflow-x:hidden;
      display:flex; flex-direction:column;
    }
    /* Background visual */
    .bg{
      position:fixed; inset:0; z-index:-2; overflow:hidden;
      background:
        radial-gradient(1000px 1000px at 80% 10%, rgba(0, 185, 255, 0.15), transparent 60%),
        radial-gradient(900px 900px at 10% 80%, rgba(153, 102, 255, 0.12), transparent 60%),
        linear-gradient(120deg, #050912, #0a0f1f 50%, #0b1230);
    }
    .bg .blob{
      position:absolute; filter: blur(60px); opacity:0.45; will-change: transform;
      mix-blend-mode: screen;
    }
    .blob.one{ width:640px; height:640px; left:-120px; top:-120px; background: radial-gradient(circle at 30% 30%, #386bff, transparent 60%), radial-gradient(circle at 75% 70%, #00d0ff, transparent 50%); animation: drift1 18s ease-in-out infinite;}
    .blob.two{ width:700px; height:700px; right:-180px; bottom:-140px; background: radial-gradient(circle at 60% 20%, #a86bff, transparent 60%), radial-gradient(circle at 20% 70%, #00ffc6, transparent 55%); animation: drift2 22s ease-in-out infinite;}
    .noise{
      position:fixed; inset:0; z-index:-1; pointer-events:none;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="120" height="120" filter="url(%23n)" opacity="0.025"/></svg>');
      background-size: 220px 220px; mix-blend-mode: overlay;
    }
    @keyframes drift1{0%{transform:translate(0,0) scale(1)} 50%{transform:translate(40px,20px) scale(1.06)} 100%{transform:translate(0,0) scale(1)}}
    @keyframes drift2{0%{transform:translate(0,0) scale(1)} 50%{transform:translate(-30px,-30px) scale(1.05)} 100%{transform:translate(0,0) scale(1)}}
    /* Header */
    .site-header{
      position:sticky; top:0; z-index:5; backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
      background: linear-gradient(to bottom, rgba(0,0,0,0.35), rgba(0,0,0,0.0));
      border-bottom: 1px solid var(--stroke);
    }
    .nav{
      max-width:1200px; margin:0 auto; padding:14px clamp(16px, 3vw, 28px);
      display:flex; align-items:center; gap:16px; justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:0.3px;
    }
    .brand .logo{
      width:36px; height:36px; border-radius:12px;
      background: conic-gradient(from 120deg, var(--accent-1), var(--accent-2), var(--accent-3), var(--accent-1));
      box-shadow: inset 0 0 0 2px rgba(255,255,255,0.25), var(--shadow-2);
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
      background: var(--panel); border:1px solid var(--stroke); color: var(--muted); font-size:13px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:12px;
      background: rgba(255,255,255,0.06); border:1px solid var(--stroke); color:var(--muted);
    }
    .fs-status{display:flex; align-items:center; gap:8px;}
    /* Containers */
    .container{
      max-width:1100px; margin:0 auto; padding: clamp(16px, 4vw, 32px);
      width:100%;
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid var(--stroke); border-radius: var(--radius-xl);
      box-shadow: var(--shadow-1); backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
    }
    .hero{
      display:grid; grid-template-columns: 1.1fr 0.9fr; gap:24px; align-items:center; padding: 28px;
    }
    .hero h1{
      font-size: clamp(28px, 5.2vw, 46px); margin:0 0 10px 0; line-height:1.1;
      letter-spacing:0.2px; font-weight:800;
      background: linear-gradient(120deg, #dfe7ff 0%, #7fb6ff 30%, #a78bfa 65%, #6df3ff 100%);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      text-shadow: 0 2px 40px rgba(110, 180, 255, 0.2);
    }
    .hero p{color: var(--muted); margin: 0 0 18px 0; font-size: clamp(14px, 2vw, 16px)}
    .rules{display:flex; flex-wrap:wrap; gap:10px; margin:14px 0 22px}
    .cta-row{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
    .btn{
      padding:12px 18px; border-radius:12px; font-weight:700; letter-spacing:0.3px; transition: transform var(--speed), box-shadow var(--speed), filter var(--speed);
    }
    .btn-primary{
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); color:#fff; box-shadow: 0 8px 26px rgba(94,129,255,0.3);
    }
    .btn-primary:hover{ transform: translateY(-1px); filter: brightness(1.05) }
    .btn-ghost{
      background: var(--panel-2); border: 1px solid var(--stroke); color: var(--text);
    }
    .hero-visual{
      position:relative; height: 320px; border-radius: var(--radius-lg); overflow:hidden; border:1px solid var(--stroke);
      background: radial-gradient(100% 100% at 80% 0, rgba(130, 142, 255, 0.14), rgba(255,255,255,0.04) 60%), linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.02));
    }
    .floating{
      position:absolute; inset:0; overflow:hidden; perspective: 800px;
    }
    .chip{
      position:absolute; padding:10px 12px; border-radius: 12px; font-size:13px; color:#e8f0ff;
      background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04)); border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
      animation: float 8s ease-in-out infinite;
    }
    .chip.c1{ left: 18px; top: 22px; transform: translateZ(30px) rotate(-2deg) }
    .chip.c2{ right: 24px; top: 60px; transform: translateZ(45px) rotate(3deg); animation-delay: 1.2s}
    .chip.c3{ left: 28px; bottom: 28px; transform: translateZ(25px) rotate(-1deg); animation-delay: 2.2s}
    .chip.c4{ right: 30px; bottom: 36px; transform: translateZ(35px) rotate(2deg); animation-delay: 0.6s}
    @keyframes float{0%,100%{transform: translateY(0) translateZ(30px)} 50%{transform: translateY(-10px) translateZ(30px)}}
    /* Quiz */
    .quiz{ margin-top: 22px; padding: 0 }
    .quiz-header{
      display:flex; align-items:center; justify-content:space-between; padding: 16px 18px; border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); border-top-left-radius: var(--radius-xl); border-top-right-radius: var(--radius-xl);
    }
    .q-progress{ display:flex; align-items:center; gap:12px; flex-wrap:wrap }
    .bar{ width: min(58vw, 440px); height: 10px; border-radius:999px; background: rgba(255,255,255,0.08); overflow:hidden; border:1px solid var(--stroke)}
    .bar > i{ display:block; height:100%; width:0%; background: linear-gradient(90deg, var(--accent-1), var(--accent-3)); transition: width 400ms ease}
    .q-body{ display:grid; grid-template-columns: 0.95fr 0.55fr; gap: 18px; padding: 18px; }
    .q-card{ padding: 18px; border: 1px solid var(--stroke); border-radius: var(--radius-lg); background: var(--panel) }
    .q-label{ display:flex; align-items:center; gap:10px; color: var(--muted) }
    .question{
      margin: 8px 0 4px; font-weight:800; letter-spacing:0.2px;
      font-size: clamp(18px, 3.4vw, 28px)
    }
    .options{
      display:grid; gap: 12px; grid-template-columns: repeat(2, minmax(0, 1fr));
      margin-top: 14px;
    }
    .option{
      position:relative; border:1px solid var(--stroke); border-radius: 14px; padding: 14px 14px; min-height: 60px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      display:flex; align-items:center; gap:12px; transition: transform var(--speed), box-shadow var(--speed), border-color var(--speed), background var(--speed);
    }
    .option:hover{ transform: translateY(-1px); box-shadow: 0 8px 24px rgba(0,0,0,0.25); border-color: rgba(130,170,255,0.5) }
    .option input{ display:none }
    .opt-index{
      width:30px; height:30px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; font-weight:700;
      background: rgba(255,255,255,0.08); border:1px solid var(--stroke); color:#d8e4ff;
    }
    .option.selected{ border-color: rgba(0, 255, 214, 0.6); box-shadow: 0 8px 28px rgba(0,255,214,0.15), inset 0 0 0 1px rgba(0,255,214,0.15) }
    .option .oval{ margin-left:auto; width:20px; height:20px; border-radius:50%; border:2px solid rgba(255,255,255,0.3); position:relative }
    .option.selected .oval{ border-color: #00e0ff }
    .option.selected .oval::after{ content:""; position:absolute; inset:3px; border-radius:50%; background: linear-gradient(135deg, #00ffd5, #00b8ff) }
    .side{
      display:flex; flex-direction:column; gap: 12px;
    }
    .timer{
      display:flex; align-items:center; gap:12px; padding: 14px; border:1px solid var(--stroke); border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
    }
    .ring{
      --p: 1;
      width:64px; height:64px; border-radius:50%;
      background:
        conic-gradient(from -90deg, #00ffd5 calc((1 - var(--p)) * 360deg), #ff6b6b 0 ),
        radial-gradient(circle at 50% 50%, #0a0f1f 60%, transparent 61%);
      display:grid; place-items:center;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.12), 0 6px 22px rgba(0,0,0,0.3);
    }
    .ring small{ font-size:11px; color: var(--muted) }
    .ring b{ font-size:18px }
    .pill-cat{ font-weight:700; font-size:12px; color:#dfe7ff }
    .actions{ display:flex; align-items:center; gap:10px; margin-top:6px; flex-wrap:wrap }
    .btn-next{ background: linear-gradient(135deg, #00ffd5, #00b8ff); color:#003; }
    .btn-submit{ background: linear-gradient(135deg, #7c4dff, #4e6bff); }
    .btn:disabled{ opacity:0.6; cursor:not-allowed; filter:saturate(0.6) }
    .keyboard{ font-size:12px; color: var(--muted) }
    /* Results */
    .results{ margin-top: 22px; overflow: hidden }
    .res-hero{
      display:grid; grid-template-columns: 0.7fr 1.3fr; gap:18px; padding: 18px;
    }
    .score-card{
      padding:16px; border:1px solid var(--stroke); border-radius: var(--radius-lg); background: var(--panel); min-height: 220px;
      display:flex; flex-direction:column; justify-content:center; gap:10px; text-align:center;
    }
    .score-number{
      font-size: clamp(28px, 4.8vw, 44px); font-weight:900; letter-spacing:0.6px;
      background: linear-gradient(120deg, #d5e2ff, #9ab7ff 45%, #9f88ff); -webkit-background-clip: text; color: transparent;
      text-shadow: 0 2px 40px rgba(110, 180, 255, 0.25);
    }
    .stats{
      display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;
    }
    .stat{
      padding:12px; border:1px solid var(--stroke); border-radius: 12px; background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .stat b{ font-size:18px }
    .chart-card{
      padding:16px; border:1px solid var(--stroke); border-radius: var(--radius-lg); background: var(--panel); min-height: 220px;
    }
    .chart{ width:100%; height:260px }
    .res-grid{
      display:grid; grid-template-columns: 1fr 1fr; gap:18px; padding: 0 18px 18px;
    }
    .breakdown{ padding:16px; border:1px solid var(--stroke); border-radius: var(--radius-lg); background: var(--panel) }
    .detail{ padding:16px; border:1px solid var(--stroke); border-radius: var(--radius-lg); background: var(--panel) }
    .list{
      max-height: 360px; overflow:auto; border:1px dashed var(--stroke); border-radius: 12px; padding:8px;
    }
    .row{
      display:grid; grid-template-columns: 28px 1fr 120px 120px 80px; gap:10px; align-items:center;
      padding:10px; border-bottom:1px dashed rgba(255,255,255,0.08);
      font-size:13px;
    }
    .row .tag{ padding:4px 8px; border-radius:999px; font-weight:700; font-size:11px; text-align:center }
    .tag.good{ background: rgba(56,224,141,0.18); color: #8ff3c1; border:1px solid rgba(56,224,141,0.3) }
    .tag.bad{ background: rgba(255,107,107,0.18); color: #ffc2c2; border:1px solid rgba(255,107,107,0.35) }
    .legend{ display:flex; align-items:center; gap:10px; color: var(--muted); font-size:12px; margin-top:8px }
    .legend i{ display:inline-block; width:10px; height:10px; border-radius:50% }
    .gauge{
      --val: 0.7;
      width: 140px; height: 140px; border-radius:50%;
      background: conic-gradient(#38e08d calc(var(--val)*360deg), rgba(255,255,255,0.12) 0 );
      display:grid; place-items:center; margin: 6px auto 0;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.12);
    }
    .gauge::after{
      content:""; width: 96px; height:96px; border-radius:50%; background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid var(--stroke);
    }
    .gauge > b{
      position:absolute; font-size:22px; font-weight:900;
    }
    .res-actions{ display:flex; align-items:center; gap:10px; margin-top:10px; flex-wrap:wrap }
    .mini{ font-size:12px; color: var(--muted) }
    /* Overlays */
    .overlay{
      position:fixed; inset:0; background: rgba(3,6,16,0.84); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      z-index:50; display:none; align-items:center; justify-content:center; padding:18px;
    }
    .overlay .modal{
      width: min(560px, 96vw); background: var(--panel); border:1px solid var(--stroke); border-radius: 16px; padding: 18px; text-align:center; box-shadow: var(--shadow-1)
    }
    .warn{ color: #ffd7a6 }
    .hidden{ display:none !important}
    /* Footer */
    .footer{
      opacity:0.6; font-size:12px; text-align:center; padding: 22px 16px;
    }
    /* Responsive */
    @media (max-width: 980px){
      .hero{ grid-template-columns: 1fr; gap:16px }
      .hero-visual{ height: 220px }
      .q-body{ grid-template-columns: 1fr; }
      .options{ grid-template-columns: 1fr; }
      .res-hero{ grid-template-columns: 1fr; }
      .res-grid{ grid-template-columns: 1fr; }
      .row{ grid-template-columns: 24px 1fr 90px 90px 60px }
      .bar{ width: 100% }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="bg">
      <div class="blob one"></div>
      <div class="blob two"></div>
    </div>
    <div class="noise"></div>

    <header class="site-header">
      <div class="nav">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>Math Mastery Quiz</div>
        </div>
        <div class="fs-status">
          <span class="badge" id="fsBadge">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="#8fd7ff" xmlns="http://www.w3.org/2000/svg"><path d="M7 14H5v5h5v-2H7v-3zm0-4h2V7h3V5H7v5zm10 9h-3v2h5v-5h-2v3zm0-9h2V5h-5v2h3v3z"/></svg>
            Fullscreen required
          </span>
          <span class="pill" id="guardPill" title="Anti-cheat enabled">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="#7be7c4" xmlns="http://www.w3.org/2000/svg"><path d="M12 1l9 4v6c0 5-3.8 9.7-9 11-5.2-1.3-9-6-9-11V5l9-4zm0 2.2L5 6.1V11c0 4.1 2.9 7.8 7 8.9 4.1-1.1 7-4.8 7-8.9V6.1l-7-2.9zM7 11l3 3 7-7 1.4 1.4L10 16.8 5.6 12.4 7 11z"/></svg>
            Anti-cheat active
          </span>
        </div>
      </div>
    </header>

    <main class="container">
      <!-- Intro -->
      <section class="panel hero" id="intro">
        <div>
          <h1>Sharpen your speed with Multiplication, Squares & Cubes</h1>
          <p>20 questions. 40 seconds per question. Fullscreen and focus required. Mobile-friendly, fast, and beautiful.</p>
          <div class="rules">
            <span class="pill">10 Ã— Multiplication (12â€“25 by 1â€“20)</span>
            <span class="pill">10 Ã— Squares & Cubes (10Â²â€“30Â², 10Â³â€“30Â³)</span>
            <span class="pill">Auto-advance every 40s</span>
            <span class="pill">Submit anytime</span>
            <span class="pill">Detailed analytics & charts</span>
          </div>
          <div class="cta-row">
            <button class="btn btn-primary" id="startBtn">Start Quiz</button>
            <button class="btn btn-ghost" id="fsBtn">Enter Fullscreen</button>
            <span class="keyboard">Tip: Use number keys 1â€“4 to answer faster</span>
          </div>
        </div>
        <div class="hero-visual">
          <div class="floating">
            <div class="chip c1">No new tabs allowed</div>
            <div class="chip c2">40s per question</div>
            <div class="chip c3">Auto submit at the end</div>
            <div class="chip c4">Instant analytics</div>
          </div>
          <canvas id="fx" width="800" height="400" style="position:absolute; inset:0; width:100%; height:100%; opacity:0.55"></canvas>
        </div>
      </section>

      <!-- Quiz -->
      <section class="panel quiz hidden" id="quiz">
        <div class="quiz-header">
          <div class="q-progress">
            <div id="qLabel">Question 1 of 20</div>
            <div class="bar"><i id="qBar"></i></div>
          </div>
          <div class="pill" id="catPill">Category: â€”</div>
        </div>
        <div class="q-body">
          <div class="q-card">
            <div class="q-label">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="#9db0e7" xmlns="http://www.w3.org/2000/svg"><path d="M21 7H7V3H5v4H3v2h2v6H3v2h2v4h2v-4h14v-2H7V9h14z"/></svg>
              <span id="qType">â€”</span>
            </div>
            <div class="question" id="qText">Loading...</div>
            <div class="options" id="options"></div>
          </div>
          <div class="side">
            <div class="timer">
              <div class="ring" id="ring">
                <div style="display:grid; place-items:center">
                  <small>SECS</small>
                  <b id="sec">40</b>
                </div>
              </div>
              <div>
                <div class="pill-cat" id="pillCat2">â€”</div>
                <div class="mini">If you run out of time, we auto-advance.</div>
              </div>
            </div>
            <div class="actions">
              <button class="btn btn-next" id="nextBtn" disabled>Next</button>
              <button class="btn btn-submit" id="submitBtn">Submit Quiz</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Results -->
      <section class="panel results hidden" id="results">
        <div class="res-hero">
          <div class="score-card">
            <div class="mini">Your Score</div>
            <div class="score-number" id="scoreText">0 / 20</div>
            <div class="gauge" id="gauge" style="--val: 0.0"><b id="percent">0%</b></div>
            <div class="res-actions">
              <button class="btn btn-primary" id="retryBtn">Retry</button>
              <button class="btn btn-ghost" id="downloadBtn">Download Report</button>
            </div>
          </div>
          <div class="chart-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px">
              <div><b>Time per Question</b></div>
              <div class="legend">
                <i style="background:#38e08d"></i> Correct
                <i style="background:#ff6b6b"></i> Wrong/Unanswered
              </div>
            </div>
            <div class="chart" id="chart"></div>
          </div>
        </div>
        <div class="res-grid">
          <div class="breakdown">
            <b>Breakdown</b>
            <div class="stats" style="margin-top:10px">
              <div class="stat"><span>Correct</span><b id="cCount">0</b></div>
              <div class="stat"><span>Wrong</span><b id="wCount">0</b></div>
              <div class="stat"><span>Unanswered</span><b id="uCount">0</b></div>
            </div>
            <div class="stats" style="margin-top:10px">
              <div class="stat"><span>Average time</span><b id="avgTime">0s</b></div>
              <div class="stat"><span>Fastest</span><b id="fastest">0s</b></div>
              <div class="stat"><span>Slowest</span><b id="slowest">0s</b></div>
            </div>
            <div class="stats" style="margin-top:10px">
              <div class="stat"><span>Multiplication (10)</span><b id="mulStat">0 / 10</b></div>
              <div class="stat"><span>Squares & Cubes (10)</span><b id="powStat">0 / 10</b></div>
              <div class="stat"><span>Focus events</span><b id="focusOuts">0</b></div>
            </div>
          </div>
          <div class="detail">
            <b>Question Details</b>
            <div class="list" id="detailList"></div>
          </div>
        </div>
      </section>

      <div class="footer">
        Staying in fullscreen and on this tab is required. Some system/browser shortcuts may still override restrictions.
      </div>
    </main>
  </div>

  <!-- Overlays -->
  <div class="overlay" id="fsOverlay">
    <div class="modal">
      <h3 style="margin:6px 0 8px">Fullscreen is required</h3>
      <p class="warn">Please allow fullscreen to continue the quiz.</p>
      <div style="margin-top:14px">
        <button class="btn btn-primary" id="ovFsBtn">Enter Fullscreen</button>
        <div class="mini" style="margin-top:6px">Mobile: rotate if needed. iOS may limit fullscreen support.</div>
      </div>
    </div>
  </div>
  <div class="overlay" id="focusOverlay">
    <div class="modal">
      <h3 style="margin:6px 0 8px">Focus lost</h3>
      <p class="warn">Please return to the quiz. Timers are paused.</p>
      <div style="margin-top:14px">
        <button class="btn btn-primary" id="resumeBtn">Resume</button>
      </div>
    </div>
  </div>
  <div class="overlay" id="blockOverlay">
    <div class="modal">
      <h3 style="margin:6px 0 8px">Action blocked</h3>
      <p class="warn">Opening new tabs or using certain shortcuts is disabled during the quiz.</p>
      <div style="margin-top:14px">
        <button class="btn btn-primary" id="blockCloseBtn">Continue</button>
      </div>
    </div>
  </div>

  <!-- D3 for charts -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    (function(){
      const $ = s => document.querySelector(s);
      const $$ = s => document.querySelectorAll(s);

      const TOTAL_Q = 20;
      const TIME_PER_Q = 40; // seconds
      const MUL_COUNT = 10;
      const POW_COUNT = 10;

      const state = {
        started: false,
        questions: [],
        current: 0,
        timer: null,
        timeLeft: TIME_PER_Q,
        qStartAt: 0,
        answers: [], // {selected: number|null, correct: boolean|null, time: number}
        focusOuts: 0,
        paused: false,
        fullscreenNeeded: true
      };

      // Generate questions
      function generateQuestions(){
        const qs = [];
        // 1) 10 Multiplication: a in 12..25, b in 1..20
        const pickedPairs = new Set();
        while(qs.filter(q=>q.category==='multiplication').length < MUL_COUNT){
          const a = randInt(12,25);
          const b = randInt(1,20);
          const key = a+'x'+b;
          if(pickedPairs.has(key)) continue;
          pickedPairs.add(key);
          const ans = a*b;
          const opts = makeMultOptions(a,b,ans);
          qs.push({
            id: qs.length+1,
            category:'multiplication',
            text: `${a} Ã— ${b} = ?`,
            correct: ans,
            options: shuffle(opts),
            meta: {a,b}
          });
        }
        // 2) 10 Squares & Cubes: ensure both types appear
        const bases = Array.from({length:21},(_,i)=>i+10); // 10..30
        const sqBases = shuffle([...bases]).slice(0,5);
        const cbBases = shuffle([...bases]).slice(0,5);
        for(const n of sqBases){
          const ans = n*n;
          const opts = makePowOptions(n,2,ans);
          qs.push({
            id: qs.length+1,
            category:'pow',
            text: `${n}<sup>2</sup> = ?`,
            correct: ans,
            options: shuffle(opts),
            meta: {n, pow:2}
          });
        }
        for(const n of cbBases){
          const ans = n*n*n;
          const opts = makePowOptions(n,3,ans);
          qs.push({
            id: qs.length+1,
            category:'pow',
            text: `${n}<sup>3</sup> = ?`,
            correct: ans,
            options: shuffle(opts),
            meta: {n, pow:3}
          });
        }
        // Keep order as spec: first mult then pow
        state.questions = qs;
        state.answers = Array(qs.length).fill(null);
      }

      function makePowOptions(n, pow, ans){
  const set = new Set([ans]);
  const lastDigit = ans % 10;

  // Nearest powers (nÂ±1, nÂ±2)
  for (let d = 1; d <= 2; d++) {
    let hi = Math.pow(n + d, pow);
    let lo = Math.pow(n - d, pow);

    if (hi > 0 && hi % 10 === lastDigit) set.add(hi);
    if (lo > 0 && lo % 10 === lastDigit) set.add(lo);
  }

  // Algebraic traps (very close, very evil ðŸ˜ˆ)
  if (pow === 2) {
    let t1 = ans + (2 * n);
    let t2 = ans - (2 * n);

    if (t1 > 0 && t1 % 10 === lastDigit) set.add(t1);
    if (t2 > 0 && t2 % 10 === lastDigit) set.add(t2);
  } else {
    let t1 = ans + (3 * n * n);
    let t2 = ans - (3 * n * n);

    if (t1 > 0 && t1 % 10 === lastDigit) set.add(t1);
    if (t2 > 0 && t2 % 10 === lastDigit) set.add(t2);
  }

  // Tight random fill (same last digit only)
  while (set.size < 4) {
    let k = ans + randInt(-3, 3) * 10;
    if (k > 0 && k % 10 === lastDigit) {
      set.add(k);
    }
  }

  return shuffle(Array.from(set).slice(0, 4));
}



      function makePowOptions(n, pow, ans){
  const set = new Set([ans]);
  const lastDigit = ans % 10;

  // Nearest powers (nÂ±1, nÂ±2)
  for (let d = 1; d <= 2; d++) {
    let hi = Math.pow(n + d, pow);
    let lo = Math.pow(n - d, pow);

    if (hi > 0 && hi % 10 === lastDigit) set.add(hi);
    if (lo > 0 && lo % 10 === lastDigit) set.add(lo);
  }

  // Algebraic traps (very close, very evil ðŸ˜ˆ)
  if (pow === 2) {
    let t1 = ans + (2 * n);
    let t2 = ans - (2 * n);

    if (t1 > 0 && t1 % 10 === lastDigit) set.add(t1);
    if (t2 > 0 && t2 % 10 === lastDigit) set.add(t2);
  } else {
    let t1 = ans + (3 * n * n);
    let t2 = ans - (3 * n * n);

    if (t1 > 0 && t1 % 10 === lastDigit) set.add(t1);
    if (t2 > 0 && t2 % 10 === lastDigit) set.add(t2);
  }

  // Tight random fill (same last digit only)
  while (set.size < 4) {
    let k = ans + randInt(-3, 3) * 10;
    if (k > 0 && k % 10 === lastDigit) {
      set.add(k);
    }
  }

  return shuffle(Array.from(set).slice(0, 4));
}



      // UI
      const screens = {
        intro: $('#intro'),
        quiz: $('#quiz'),
        results: $('#results')
      };
      function showScreen(name){
        Object.values(screens).forEach(el=>el.classList.add('hidden'));
        screens[name].classList.remove('hidden');
      }

      // Render question
      const qLabel = $('#qLabel');
      const qBar = $('#qBar');
      const qType = $('#qType');
      const qText = $('#qText');
      const optionsEl = $('#options');
      const ring = $('#ring');
      const secEl = $('#sec');
      const catPill = $('#catPill');
      const pillCat2 = $('#pillCat2');
      const nextBtn = $('#nextBtn');
      const submitBtn = $('#submitBtn');

      function categoryLabel(q){
        if(q.category==='multiplication') return 'Multiplication';
        if(q.meta.pow===2) return 'Squares';
        return 'Cubes';
      }

      function startQuestion(index){
        if(index<0 || index>=state.questions.length) return;
        state.current = index;
        state.timeLeft = TIME_PER_Q;
        state.qStartAt = performance.now();
        state.paused = false;
        updateHeader();
        renderQuestion();
        startTimer();
      }

      function updateHeader(){
        const i = state.current+1;
        const total = state.questions.length;
        qLabel.textContent = `Question ${i} of ${total}`;
        qBar.style.width = `${(i-1)/total*100}%`;
        const q = state.questions[state.current];
        const label = categoryLabel(q);
        catPill.textContent = `Category: ${label}`;
        pillCat2.textContent = label;
        $('#qLabel').title = `Progress: ${(i-1)}/${total}`;
      }

      function renderQuestion(){
        const q = state.questions[state.current];
        qType.textContent = q.category==='multiplication' ? 'Solve the product' : (q.meta.pow===2?'Find the square':'Find the cube');
        qText.innerHTML = q.text;
        optionsEl.innerHTML = '';
        const opts = q.options;
        const abc = ['A','B','C','D'];
        const prev = state.answers[state.current]?.selected ?? null;
        opts.forEach((v,idx)=>{
          const div = document.createElement('label');
          div.className = 'option';
          if(prev===v) div.classList.add('selected');
          div.setAttribute('data-value', v);
          div.innerHTML = `
            <input type="radio" name="opt" value="${v}">
            <span class="opt-index">${abc[idx]}</span>
            <div class="opt-text" style="font-weight:700; font-size: clamp(16px, 2.4vw, 20px)">${formatNumber(v)}</div>
            <span class="oval" aria-hidden="true"></span>
          `;
          div.addEventListener('click', ()=>{
            $$('.option').forEach(o=>o.classList.remove('selected'));
            div.classList.add('selected');
            nextBtn.disabled = false;
          });
          optionsEl.appendChild(div);
        });
        nextBtn.disabled = prev==null;
        ring.style.setProperty('--p', 1);
        secEl.textContent = TIME_PER_Q;
      }

      function startTimer(){
        stopTimer();
        state.timer = setInterval(()=>{
          if(state.paused) return;
          state.timeLeft -= 1;
          const p = Math.max(0, state.timeLeft) / TIME_PER_Q;
          ring.style.setProperty('--p', p.toFixed(4));
          secEl.textContent = Math.max(0, Math.ceil(state.timeLeft));
          if(state.timeLeft<=0){
            recordAnswer(null); // unanswered
            autoNextOrSubmit();
          }
        }, 1000);
      }

      function stopTimer(){
        if(state.timer){ clearInterval(state.timer); state.timer = null; }
      }

      function getSelectedValue(){
        const sel = $('.option.selected');
        if(!sel) return null;
        const v = Number(sel.getAttribute('data-value'));
        return Number.isFinite(v)? v : null;
      }

      function recordAnswer(selected){
        // Only record if not already recorded this question or update if changed
        const idx = state.current;
        const q = state.questions[idx];
        const elapsed = Math.min(TIME_PER_Q, Math.round((performance.now()-state.qStartAt)/1000));
        const chosen = selected;
        const correct = chosen!=null ? (chosen===q.correct) : false;
        state.answers[idx] = { selected: chosen, correct: chosen===null ? false : correct, time: elapsed };
      }

      function autoNextOrSubmit(){
        stopTimer();
        const last = state.current === state.questions.length-1;
        if(last){
          submitQuiz();
        }else{
          startQuestion(state.current+1);
        }
      }

      function nextQuestion(){
        const chosen = getSelectedValue();
        if(chosen==null) return;
        recordAnswer(chosen);
        autoNextOrSubmit();
      }

      function submitQuiz(){
        stopTimer();
        // Record current if missing
        if(!state.answers[state.current]){
          const sel = getSelectedValue();
          if(sel==null){
            recordAnswer(null);
          }else{
            recordAnswer(sel);
          }
        }
        showResults();
      }

      // Results
      const scoreText = $('#scoreText');
      const gauge = $('#gauge');
      const percentEl = $('#percent');
      const cCount = $('#cCount');
      const wCount = $('#wCount');
      const uCount = $('#uCount');
      const avgTime = $('#avgTime');
      const fastest = $('#fastest');
      const slowest = $('#slowest');
      const mulStat = $('#mulStat');
      const powStat = $('#powStat');
      const focusOuts = $('#focusOuts');
      const detailList = $('#detailList');

      function showResults(){
        showScreen('results');
        const A = state.answers.map((a,i)=> a || {selected:null, correct:false, time:TIME_PER_Q});
        const total = A.length;
        let correctN = 0, wrongN = 0, unansN = 0;
        let sumT = 0;
        let mulCorrect=0, powCorrect=0;
        let mulTotal=0, powTotal=0;
        let minT = Infinity, maxT = -Infinity;

        for(let i=0;i<total;i++){
          const a = A[i];
          const q = state.questions[i];
          sumT += a.time;
          minT = Math.min(minT, a.time);
          maxT = Math.max(maxT, a.time);
          if(a.selected==null) unansN++;
          if(a.correct) correctN++; else wrongN++;
          if(q.category==='multiplication'){ mulTotal++; if(a.correct) mulCorrect++; }
          else { powTotal++; if(a.correct) powCorrect++; }
        }
        const pct = Math.round(correctN/total*100);
        scoreText.textContent = `${correctN} / ${total}`;
        percentEl.textContent = `${pct}%`;
        gauge.style.setProperty('--val', (correctN/total).toFixed(3));
        cCount.textContent = correctN;
        wCount.textContent = wrongN - unansN;
        uCount.textContent = unansN;
        avgTime.textContent = `${(sumT/total).toFixed(1)}s`;
        fastest.textContent = `${minT===Infinity?0:minT}s`;
        slowest.textContent = `${maxT===-Infinity?0:maxT}s`;
        mulStat.textContent = `${mulCorrect} / ${mulTotal}`;
        powStat.textContent = `${powCorrect} / ${powTotal}`;
        focusOuts.textContent = state.focusOuts;

        // Detail list
        detailList.innerHTML = '';
        state.questions.forEach((q,i)=>{
          const a = A[i];
          const row = document.createElement('div');
          row.className = 'row';
          const tag = document.createElement('span');
          tag.className = 'tag ' + (a.correct?'good':'bad');
          tag.textContent = a.correct?'OK':'X';
          row.appendChild(tag);

          const txt = document.createElement('div');
          txt.innerHTML = `${i+1}. ${q.text}`;
          row.appendChild(txt);

          const your = document.createElement('div');
          your.innerHTML = `<span class="mini">Your:</span> <b>${a.selected==null? 'â€”' : formatNumber(a.selected)}</b>`;
          row.appendChild(your);

          const corr = document.createElement('div');
          corr.innerHTML = `<span class="mini">Ans:</span> <b>${formatNumber(q.correct)}</b>`;
          row.appendChild(corr);

          const t = document.createElement('div');
          t.innerHTML = `<span class="mini">Time:</span> <b>${a.time}s</b>`;
          row.appendChild(t);

          detailList.appendChild(row);
        });

        // Chart
        drawChart(A.map(a=>a.time), state.answers.map(a=>a?.correct??false));
      }

      function formatNumber(n){
        const s = n.toString();
        if(s.length<=6) return s;
        return s.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }

      function drawChart(times, correctFlags){
        const el = $('#chart');
        el.innerHTML = '';
        const w = el.clientWidth || 600;
        const h = el.clientHeight || 260;
        const m = {top:16,right:22,bottom:28,left:36};
        const iw = w - m.left - m.right;
        const ih = h - m.top - m.bottom;
        const svg = d3.select(el).append('svg').attr('width', w).attr('height', h);
        const g = svg.append('g').attr('transform', `translate(${m.left},${m.top})`);

        const x = d3.scaleLinear().domain([1, times.length]).range([0, iw]);
        const y = d3.scaleLinear().domain([0, TIME_PER_Q]).nice().range([ih, 0]);

        const gx = g.append('g').attr('transform', `translate(0,${ih})`).call(d3.axisBottom(x).ticks(Math.min(10,times.length)).tickSizeOuter(0));
        gx.selectAll('text').style('fill','#a9b8e8').style('font-size','11px');
        gx.selectAll('path,line').style('stroke','rgba(255,255,255,0.15)');
        const gy = g.append('g').call(d3.axisLeft(y).ticks(5).tickSizeOuter(0));
        gy.selectAll('text').style('fill','#a9b8e8').style('font-size','11px');
        gy.selectAll('path,line').style('stroke','rgba(255,255,255,0.15)');

        g.append('g').selectAll('line.gridH')
          .data(y.ticks(5)).enter().append('line')
          .attr('x1',0).attr('x2',iw).attr('y1',d=>y(d)).attr('y2',d=>y(d))
          .attr('stroke','rgba(255,255,255,0.08)');

        const line = d3.line()
          .x((d,i)=>x(i+1))
          .y(d=>y(d))
          .curve(d3.curveMonotoneX);
        g.append('path')
          .datum(times)
          .attr('fill','none')
          .attr('stroke','url(#gradLine)')
          .attr('stroke-width',2.2)
          .attr('d', line);

        const defs = svg.append('defs');
        const grad = defs.append('linearGradient').attr('id','gradLine').attr('x1','0').attr('x2','1').attr('y1','0').attr('y2','0');
        grad.append('stop').attr('offset','0%').attr('stop-color','#7da7ff');
        grad.append('stop').attr('offset','100%').attr('stop-color','#3df0ff');

        // Avg line
        const avg = d3.mean(times);
        g.append('line')
          .attr('x1',0).attr('x2',iw).attr('y1',y(avg)).attr('y2',y(avg))
          .attr('stroke','rgba(255,255,255,0.25)').attr('stroke-dasharray','4,4');
        g.append('text').attr('x',iw-4).attr('y',y(avg)-6).attr('text-anchor','end').text(`avg ${avg.toFixed(1)}s`)
          .style('fill','#a9b8e8').style('font-size','10px');

        const pts = g.selectAll('circle.pt').data(times).enter().append('circle')
          .attr('class','pt')
          .attr('cx',(d,i)=>x(i+1))
          .attr('cy',d=>y(d))
          .attr('r',4.2)
          .attr('fill',(d,i)=> correctFlags[i] ? '#38e08d' : '#ff6b6b')
          .attr('stroke','rgba(0,0,0,0.4)');

        const tip = d3.select(el).append('div').style('position','absolute').style('pointer-events','none').style('padding','6px 8px').style('font-size','12px').style('background','rgba(8,12,24,0.9)').style('border','1px solid rgba(255,255,255,0.18)').style('border-radius','8px').style('backdrop-filter','blur(6px)').style('color','#cfe1ff').style('display','none');
        pts.on('mouseenter', function(e, d){
          const i = times.indexOf(d, this.__dataIndex??0);
          tip.style('display','block').html(`Q${i+1}: <b>${d.toFixed(1)}s</b>`);
        }).on('mousemove', function(e){
          const rect = el.getBoundingClientRect();
          tip.style('left', (e.clientX - rect.left + 12) + 'px').style('top', (e.clientY - rect.top - 6) + 'px');
        }).on('mouseleave', ()=> tip.style('display','none'));
      }

      // Fullscreen
      async function enterFullscreen(){
        const el = document.documentElement;
        try{
          if(el.requestFullscreen) await el.requestFullscreen();
          else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
          else if(el.msRequestFullscreen) await el.msRequestFullscreen();
          $('#fsBadge').innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="#7be7c4" xmlns="http://www.w3.org/2000/svg"><path d="M7 14H5v5h5v-2H7v-3zm0-4h2V7h3V5H7v5zm10 9h-3v2h5v-5h-2v3zm0-9h2V5h-5v2h3v3z"/></svg> Fullscreen on`;
          $('#fsOverlay').style.display='none';
          try{ if(screen.orientation && screen.orientation.lock){ await screen.orientation.lock('portrait'); } }catch(e){}
          state.fullscreenNeeded = false;
        }catch(e){
          $('#fsOverlay').style.display='flex';
        }
      }
      function isFullscreen(){
        return document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
      }
      document.addEventListener('fullscreenchange', ()=>{
        if(isFullscreen()){
          $('#fsBadge').innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="#7be7c4" xmlns="http://www.w3.org/2000/svg"><path d="M7 14H5v5h5v-2H7v-3zm0-4h2V7h3V5H7v5zm10 9h-3v2h5v-5h-2v3zm0-9h2V5h-5v2h3v3z"/></svg> Fullscreen on`;
          $('#fsOverlay').style.display='none';
        }else{
          $('#fsBadge').innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="#ffcf7d" xmlns="http://www.w3.org/2000/svg"><path d="M7 14H5v5h5v-2H7v-3zm0-4h2V7h3V5H7v5zm10 9h-3v2h5v-5h-2v3zm0-9h2V5h-5v2h3v3z"/></svg> Fullscreen required`;
          if(state.started && !state.paused){
            pauseForFocusLoss('Please re-enter fullscreen to continue.');
          }
        }
      });

      // Focus & anti-cheat
      function pauseForFocusLoss(msg){
        state.paused = true;
        stopTimer();
        $('#focusOverlay .warn').textContent = msg || 'Please return to the quiz. Timers are paused.';
        $('#focusOverlay').style.display='flex';
        state.focusOuts++;
      }
      function resumeFromPause(){
        $('#focusOverlay').style.display='none';
        state.paused = false;
        state.qStartAt = performance.now() - (TIME_PER_Q - state.timeLeft)*1000;
        startTimer();
      }
      document.addEventListener('visibilitychange', ()=>{
        if(document.hidden && state.started && screens.quiz && !screens.quiz.classList.contains('hidden')){
          pauseForFocusLoss('Quiz paused because tab lost focus.');
        }
      });

      // Block shortcuts/new tabs
      function showBlock(){
        const ov = $('#blockOverlay');
        if(ov.style.display!=='flex'){
          ov.style.display='flex';
          setTimeout(()=>{},10);
        }
      }
      $('#blockCloseBtn').addEventListener('click', ()=> $('#blockOverlay').style.display='none');
      window.open = ()=>{ showBlock(); return null; };
      document.addEventListener('contextmenu', e=> e.preventDefault(), {passive:false});
      ['copy','cut','paste'].forEach(ev=> document.addEventListener(ev, e=> e.preventDefault()));
      document.addEventListener('keydown', (e)=>{
        const k = (e.key||'').toLowerCase();
        const blockComb = (e.ctrlKey||e.metaKey) && ['t','n','w','l','r','o','p','s','i','j','k','h','[',']','+','-','=', '0'].includes(k);
        const funcKeys = ['f11','f12'].includes(k);
        const navKeys = (e.altKey && (k==='tab' || k==='left' || k==='right'));
        if(blockComb || funcKeys || navKeys){
          e.preventDefault(); e.stopPropagation(); showBlock(); return false;
        }
        // Answer shortcuts 1-4
        if(!screens.quiz.classList.contains('hidden') && ['1','2','3','4'].includes(k)){
          const idx = Number(k)-1;
          const opt = $$('.option')[idx];
          if(opt){ opt.click(); }
        }
        // Enter to next
        if(k==='enter' && !screens.quiz.classList.contains('hidden')){
          if(!nextBtn.disabled) nextQuestion();
        }
      }, {capture:true});

      window.addEventListener('beforeunload', (e)=>{
        if(state.started){
          e.preventDefault();
          e.returnValue = '';
        }
      });

      // Controls
      $('#startBtn').addEventListener('click', async ()=>{
        generateQuestions();
        state.started = true;
        showScreen('quiz');
        await enterFullscreen();
        startQuestion(0);
      });
      $('#fsBtn').addEventListener('click', enterFullscreen);
      $('#ovFsBtn').addEventListener('click', enterFullscreen);
      $('#resumeBtn').addEventListener('click', resumeFromPause);

      nextBtn.addEventListener('click', nextQuestion);
      submitBtn.addEventListener('click', submitQuiz);
      $('#retryBtn').addEventListener('click', ()=>{
        stopTimer();
        state.started = false;
        state.focusOuts = 0;
        generateQuestions();
        showScreen('intro');
        detailList.innerHTML = '';
        $('#chart').innerHTML = '';
      });
      $('#downloadBtn').addEventListener('click', ()=>{
        const report = buildReport();
        const blob = new Blob([JSON.stringify(report,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `math-quiz-report-${Date.now()}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      function buildReport(){
        const items = state.questions.map((q,i)=>({
          index: i+1,
          category: categoryLabel(q),
          text: q.text.replace(/<[^>]+>/g,''),
          options: q.options,
          correct: q.correct,
          selected: state.answers[i]?.selected ?? null,
          isCorrect: state.answers[i]?.correct ?? false,
          time: state.answers[i]?.time ?? TIME_PER_Q
        }));
        const correctCount = items.filter(x=>x.isCorrect).length;
        return {
          score: `${correctCount} / ${items.length}`,
          percent: Math.round(correctCount/items.length*100),
          focusEvents: state.focusOuts,
          timePerQuestion: items.map(x=>x.time),
          items
        };
      }

      // FX Canvas
      function fx(){
        const c = $('#fx');
        if(!c) return;
        const ctx = c.getContext('2d');
        let W = c.width = c.clientWidth * devicePixelRatio;
        let H = c.height = c.clientHeight * devicePixelRatio;
        const dots = Array.from({length:60}, ()=>({
          x: Math.random()*W, y: Math.random()*H,
          vx: (Math.random()*2-1)*0.12*devicePixelRatio,
          vy: (Math.random()*2-1)*0.12*devicePixelRatio,
          r: (Math.random()*2+1)*devicePixelRatio
        }));
        function step(){
          ctx.clearRect(0,0,W,H);
          for(const d of dots){
            d.x += d.vx; d.y += d.vy;
            if(d.x<0||d.x>W) d.vx*=-1;
            if(d.y<0||d.y>H) d.vy*=-1;
          }
          // connections
          for(let i=0;i<dots.length;i++){
            const a = dots[i];
            for(let j=i+1;j<dots.length;j++){
              const b = dots[j];
              const dx=a.x-b.x, dy=a.y-b.y;
              const dist = Math.hypot(dx,dy);
              if(dist<120*devicePixelRatio){
                const alpha = 1 - dist/(120*devicePixelRatio);
                ctx.strokeStyle = `rgba(130,170,255,${alpha*0.24})`;
                ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
              }
            }
          }
          for(const d of dots){
            ctx.beginPath();
            const grad = ctx.createRadialGradient(d.x,d.y,0,d.x,d.y,d.r*2);
            grad.addColorStop(0, 'rgba(120,200,255,0.9)');
            grad.addColorStop(1, 'rgba(120,200,255,0)');
            ctx.fillStyle = grad;
            ctx.arc(d.x,d.y,d.r,0,Math.PI*2);
            ctx.fill();
          }
          requestAnimationFrame(step);
        }
        step();
        window.addEventListener('resize', ()=>{
          W = c.width = c.clientWidth * devicePixelRatio;
          H = c.height = c.clientHeight * devicePixelRatio;
        });
      }
      fx();

      // Init
      generateQuestions();

    })();
  </script>
</body>
</html>